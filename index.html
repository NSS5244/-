<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>가상 남자친구 — 설정→이미지→채팅 (완전 동작)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --muted:#8a93a6; --text:#e7ecf7; --accent:#7aa2ff;
    --border:#242a36; --bubble-me:#0a84ff; --bubble-him:#2a2f3a; --header:#0b0e13; --send:#0a84ff; --radius:18px;
    --font:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0e13,#0f1115 40%);color:var(--text);font:15px/1.45 var(--font)}
  .wrap{max-width:980px;margin:20px auto;padding:14px}
  header{display:flex;gap:10px;align-items:center;margin-bottom:14px}
  h1{font-size:18px;margin:0}
  .nav{display:flex;gap:8px;margin-left:auto;flex-wrap:wrap}
  .nav button{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
  .nav .active{border-color:var(--accent);background:#0d1220}
  .pill{padding:6px 10px;border:1px dashed var(--border);border-radius:999px;color:var(--muted);font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  label{display:block;margin:8px 2px 6px;color:var(--muted);font-size:12px}
  input,select,textarea{width:100%;background:#0c0f16;border:1px solid var(--border);color:var(--text);padding:12px;border-radius:12px;outline:none}
  .grid{display:grid;gap:14px}
  .col2{grid-template-columns:1fr 1fr}
  @media(max-width:720px){.col2{grid-template-columns:1fr}}
  .btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;color:#fff;cursor:pointer;font-weight:700}
  .primary{background:var(--accent)} .ghost{background:transparent;border:1px solid var(--border)}
  .hidden{display:none}
  /* chat */
  .phone{width:390px;max-width:100%;margin:0 auto;border-radius:34px;border:1px solid #222;background:var(--bg);box-shadow:0 15px 40px rgba(0,0,0,.5);overflow:hidden}
  .notch{height:30px;background:linear-gradient(#0a0a0a,#111);border-bottom:1px solid #191919}
  .chat{height:520px;display:flex;flex-direction:column}
  .chat-header{padding:10px 14px;border-bottom:1px solid #1c1f28;display:flex;gap:10px;align-items:center;background:var(--header)}
  .avatar{width:30px;height:30px;border-radius:50%;overflow:hidden;border:1px solid #222;background:#222;display:grid;place-items:center}
  .msgs{flex:1;overflow:auto;background:#0b0f15;padding:12px}
  .msg-row{display:flex;margin:6px 0}
  .msg{max-width:75%;padding:10px 12px;border-radius:var(--radius);white-space:pre-wrap;word-break:break-word}
  .me{justify-content:flex-end}
  .me .msg{background:var(--bubble-me);color:#fff;border-bottom-right-radius:6px}
  .him .msg{background:var(--bubble-him);color:#e6ecff;border-bottom-left-radius:6px}
  .time{font-size:11px;color:#8a93a6;margin:2px 6px}
  .composer{display:flex;gap:8px;align-items:center;padding:10px;border-top:1px solid #1c1f28;background:var(--header)}
  .composer input{flex:1;border-radius:20px;padding:12px 14px;background:#0d121a;border:1px solid #1c2030;color:#e7ecf7}
  .composer .send{background:var(--send);border-radius:50%;width:40px;height:40px;display:grid;place-items:center;color:#fff;font-weight:900}
  /* tag chips */
  .tagger{display:flex;gap:8px;flex-wrap:wrap}
  .tag{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer;color:#cdd6ee}
  .tag.active{border-color:var(--accent);background:#0f1a2e}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>가상 ‘남자친구’ 문자</h1>
    <div class="nav">
      <button class="active" data-step="setup">설정</button>
      <button data-step="image">이미지</button>
      <button data-step="chat">채팅</button>
      <button id="resetAll" class="ghost">초기화</button>
    </div>
  </header>

  <div class="row" style="margin-bottom:10px">
    <div class="pill">포인트: <b id="points">0</b> P</div>
    <div class="pill">누적 대화 수: <b id="msgCount">0</b></div>
    <div class="pill">활성 테마: <b id="activeTheme">기본</b></div>
  </div>

  <!-- STEP 1: 설정 -->
  <section id="step-setup" class="card">
    <div class="grid">
      <h2 style="margin:0">내 정보</h2>
      <div class="grid col2">
        <div><label>내 닉네임</label><input id="meName" placeholder="예: 은별"></div>
        <div><label>나이</label><input id="meAge" type="number" placeholder="25" min="10" max="99"></div>
      </div>
      <h2 style="margin:8px 0 0">남자친구</h2>
      <div class="grid col2">
        <div><label>이름</label><input id="bfName" placeholder="예: 민준"></div>
        <div><label>나이</label><input id="bfAge" type="number" placeholder="27" min="10" max="99"></div>
      </div>
      <div class="grid col2">
        <div><label>말투</label>
          <select id="tone"><option>다정한</option><option>츤데레</option><option>능청스러운</option><option>차분한</option><option>장난꾸러기</option></select>
        </div>
        <div><label>취미(쉼표)</label><input id="hobbies" placeholder="커피, 러닝, 게임"></div>
      </div>
      <div><label>소개</label><input id="bio" placeholder="새벽 러닝하는 개발자"></div>

      <div>
        <label>관계 컨셉(복수 선택)</label>
        <div id="concepts" class="tagger"></div>
      </div>

      <div class="row"><button id="toImage" class="btn primary">다음: 이미지</button></div>
    </div>
  </section>

  <!-- STEP 2: 이미지 -->
  <section id="step-image" class="card hidden">
    <h2 style="margin:0 0 10px">외모 & 아바타</h2>
    <div class="grid col2">
      <div class="grid">
        <div class="grid col2">
          <div><label>헤어스타일</label>
            <select id="styleHair"><option>숏컷</option><option>투블럭</option><option>장발</option><option>웨이브</option><option>포마드</option><option>댄디</option></select>
          </div>
          <div><label>분위기</label>
            <select id="styleVibe"><option>따뜻함</option><option>시크</option><option>청량</option><option>도도</option><option>부드러움</option><option>스포티</option></select>
          </div>
        </div>
        <div class="grid col2">
          <div><label>키(cm)</label><input id="height" type="number" min="150" max="210" placeholder="178"></div>
          <div><label>체형</label><select id="build"><option>슬림</option><option>균형</option><option>근육형</option><option>탄탄</option></select></div>
        </div>
        <div><label>프롬프트(선택)</label><textarea id="prompt" placeholder="자연광, 미소, 흰 셔츠, 상반신"></textarea></div>
        <div class="row">
          <button id="gen" class="btn">이미지 생성</button>
          <button id="toChat" class="btn primary">채팅 시작</button>
          <span class="pill" id="genStatus">대기 중…</span>
        </div>
      </div>
      <div class="grid">
        <canvas id="avatar" width="360" height="360"></canvas>
        <div class="row"><div class="avatar"><img id="avatarMini" alt="아바타"></div><span class="pill">채팅 프로필에 사용</span></div>
      </div>
    </div>
  </section>

  <!-- STEP 3: 채팅 -->
  <section id="step-chat" class="hidden">
    <div class="grid col2">
      <div class="card">
        <div class="phone">
          <div class="notch"></div>
          <div class="chat">
            <div class="chat-header">
              <div class="avatar"><img id="chatAvatar" alt=""></div>
              <div><div id="chatTitle" style="font-weight:800">남친</div><div id="chatSub" style="font-size:12px;color:#8a93a6">메시지</div></div>
              <div style="margin-left:auto"><button id="resetChat" class="ghost btn">대화 초기화</button></div>
            </div>
            <div class="msgs" id="msgs" aria-live="polite"></div>
            <div class="composer">
              <input id="inputMsg" placeholder="메시지…" autocomplete="off">
              <button class="send" id="sendBtn">➤</button>
            </div>
          </div>
        </div>
        <div class="pill" style="margin-top:8px">※ 100메시지마다 10P</div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px">세션 요약 / 기억</h3>
        <div id="summary" class="grid"></div>
        <div class="pill">키워드: <span id="memkeys"></span></div>
      </div>
    </div>
  </section>
</div>

<script>
/* ========= 전역 상태(localStorage) ========= */
const KEY='gbf_full_ok_v1';
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const state = JSON.parse(localStorage.getItem(KEY)||'{}');
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function setHeader(){ $('#points').textContent=state.points||0; $('#msgCount').textContent=state.msgCount||0; $('#activeTheme').textContent=state.activeTheme||'기본'; }
state.points??=0; state.msgCount??=0; state.activeTheme??='기본'; state.memory??={keys:[],facts:{},summary:''};
setHeader();

/* ========= 네비/뷰 전환 ========= */
function show(step){
  ['setup','image','chat'].forEach(s=>{
    $('#step-'+s).classList.toggle('hidden', s!==step);
    $$('.nav button').forEach(b=> b.classList.toggle('active', b.dataset.step===step));
  });
  if(step==='chat'){ buildChatHeader(); buildSummary(); if(!state.chat || !state.chat.length) seedIntro(); else restoreChat(); }
}
$$('.nav button').forEach(b=> b.addEventListener('click', ()=>show(b.dataset.step)));
$('#resetAll').onclick=()=>{ if(confirm('모든 데이터 초기화할까요?')){ localStorage.removeItem(KEY); location.reload(); } };

/* ========= 태그(컨셉) ========= */
const conceptsList=['썸','오래된 연인','장거리','비밀연애','직장동료','캠퍼스','첫사랑','재회','슬로번','알콩달콩','티키타카'];
(function renderConcepts(){
  const root=$('#concepts'); const sel=new Set(state.concepts||[]);
  root.innerHTML=''; conceptsList.forEach(t=>{
    const b=document.createElement('button'); b.className='tag'+(sel.has(t)?' active':''); b.textContent=t;
    b.onclick=()=>{ sel.has(t)?sel.delete(t):sel.add(t); b.classList.toggle('active'); state.concepts=[...sel]; save(); };
    root.appendChild(b);
  });
})();

/* ========= 입력 동기화 ========= */
['meName','meAge','bfName','bfAge','tone','hobbies','bio','styleHair','styleVibe','height','build','prompt'].forEach(id=>{
  const el=document.getElementById(id); if(!el) return;
  if(state[id]!=null) el.value=state[id];
  el.addEventListener('input', e=>{ state[id]=e.target.value; save(); });
});

/* ========= 단계 버튼 ========= */
$('#toImage').onclick=()=>{
  if(!state.meName || !state.bfName){ alert('내 닉네임과 남자친구 이름을 입력해 주세요.'); return; }
  save(); show('image');
};
$('#toChat').onclick=()=>{ save(); show('chat'); };

/* ========= 아바타 생성(로컬 캔버스) ========= */
function prng(seed){ let x=Math.abs(seed|0)||1234567; return ()=> (x=(x*1664525+1013904223)>>>0)/2**32; }
function hash(s){let h=0; for(let i=0;i<s.length;i++) h=(h*31+s.charCodeAt(i))|0; return h;}
function genAvatar(){
  const c=$('#avatar'), ctx=c.getContext('2d'), r=prng(hash((state.bfName||'남친')+(state.styleVibe||'따뜻함')+(state.styleHair||'숏컷')));
  const g=ctx.createLinearGradient(0,0,c.width,c.height), baseH=Math.floor(r()*360);
  g.addColorStop(0,`hsl(${baseH},70%,35%)`); g.addColorStop(1,`hsl(${(baseH+45)%360},70%,22%)`);
  ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height);
  for(let i=0;i<3;i++){ ctx.beginPath(); ctx.arc(180,170,120-i*18,0,Math.PI*2); ctx.strokeStyle=`hsla(${(baseH+i*15)%360},70%,65%,.25)`; ctx.lineWidth=8; ctx.stroke(); }
  const skin=`hsl(${30+r()*10},40%,74%)`; ctx.fillStyle=skin; ctx.beginPath(); ctx.arc(180,170,70,0,Math.PI*2); ctx.fill();
  ctx.fillStyle=`hsl(${baseH},25%,10%)`; ctx.beginPath(); const hOff=(state.styleHair||'').includes('장발')?40:(state.styleHair||'').includes('웨이브')?20:0; ctx.ellipse(180,130,90,60+hOff,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#fff'; ctx.fillRect(150,165,12,4); ctx.fillRect(198,165,12,4); ctx.fillStyle='#ddd'; ctx.fillRect(170,190,20,4);
  ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(0,c.height-48,c.width,48);
  ctx.fillStyle='#fff'; ctx.font='bold 16px var(--font)'; ctx.fillText(`${state.styleHair||'헤어'} · ${state.styleVibe||'분위기'}`,14,c.height-16);
  const data=c.toDataURL('image/png'); state.avatarData=data; save();
  $('#avatarMini').src=data; $('#chatAvatar').src=data;
}
if(state.avatarData){ $('#avatarMini').src=state.avatarData; }
$('#gen').onclick=()=>{ genAvatar(); $('#genStatus').textContent='생성 완료'; setTimeout(()=>$('#genStatus').textContent='대기 중…',1200); };

/* ========= 채팅 ========= */
const msgsEl=$('#msgs');
function addMsg(text, who='him', ts=Date.now()){
  const row=document.createElement('div'); row.className='msg-row '+(who==='me'?'me':'him');
  const b=document.createElement('div'); b.className='msg'; b.textContent=text; row.appendChild(b); msgsEl.appendChild(row);
  const t=document.createElement('div'); t.className='time '+(who==='me'?'right':''); t.textContent=new Date(ts).toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}); msgsEl.appendChild(t);
  msgsEl.scrollTop=msgsEl.scrollHeight;
  state.chat=state.chat||[]; state.chat.push({who,text,ts}); save();
  state.msgCount=(state.msgCount||0)+1; if(state.msgCount%100===0){ state.points=(state.points||0)+10; save(); } setHeader();
  remember(text, who); buildSummary();
}
function buildChatHeader(){
  $('#chatTitle').textContent=state.bfName||'남친';
  $('#chatSub').textContent=state.bio||'메시지';
  if(state.avatarData) $('#chatAvatar').src=state.avatarData;
}
function seedIntro(){
  msgsEl.innerHTML=''; addMsg(`안녕 ${state.meName||''}. ${state.bfName||'나야'}.`);
  setTimeout(()=>addMsg((state.concepts&&state.concepts.length)?`우리 컨셉은 "${state.concepts.join(', ')}" 맞지?`:'오늘 뭐 하고 싶어?'),'him', 420);
}
function restoreChat(){ msgsEl.innerHTML=''; state.chat.forEach(m=>addMsg(m.text,m.who,m.ts)); }
function send(){
  const v=$('#inputMsg').value.trim(); if(!v) return;
  addMsg(v,'me'); $('#inputMsg').value='';
  setTimeout(()=> addMsg(personalityReply(v),'him'), 420+Math.random()*500);
}
$('#sendBtn').onclick=send;
$('#inputMsg').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});
$('#resetChat').onclick=()=>{ if(confirm('대화만 초기화(기억 유지)할까요?')){ state.chat=[]; save(); seedIntro(); } };

/* ========= 기억/요약 & 답변 ========= */
function buildSummary(){
  const s=$('#summary'); s.innerHTML='';
  const row=(k,v)=>{ const d=document.createElement('div'); d.innerHTML=`<label style="color:#8a93a6;font-size:12px">${k}</label><div>${v||'-'}</div>`; s.appendChild(d); };
  row('내 닉네임', state.meName); row('내 나이', state.meAge);
  row('남친 이름', state.bfName); row('남친 나이', state.bfAge);
  row('말투', state.tone); row('취미', state.hobbies); row('소개', state.bio);
  row('외모', `${state.styleHair||'-'} / ${state.styleVibe||'-'} / ${state.height||'-'}cm / ${state.build||'-'}`);
  $('#memkeys').textContent=(state.memory?.keys||[]).slice(-12).join(', ');
}
function remember(text, who){
  state.memory=state.memory||{keys:[],facts:{},summary:''};
  const mem=state.memory;
  const words=text.replace(/[^\p{Letter}\p{Number}\s]/gu,' ').split(/\s+/).map(w=>w.trim()).filter(w=>w.length>=2&&w.length<=10);
  for(const w of words){ if(!['그리고','하지만','오늘','그냥','지금','우리','너무'].includes(w)) mem.keys.push(w); }
  if(who==='me'){ const m=text.match(/(치킨|피자|라면|초밥|파스타|떡볶이|마라탕|비빔밥|햄버거|샐러드)/); if(m) mem.facts.favorite_food=m[1]; }
  const recent=(state.chat||[]).slice(-12).map(m=> (m.who==='me'?'나: ':'그: ')+m.text); mem.summary=recent.join(' / ');
  save();
}
function personalityReply(userText){
  const t=userText.toLowerCase(); const tone=state.tone||'다정한'; const traits=new Set(state.traits||[]);
  const hobbies=(state.hobbies||'').split(',').map(s=>s.trim()).filter(Boolean);
  const mem=state.memory||{keys:[],facts:{}};
  let hook=''; for(const k of (mem.keys||[]).slice(-8)){ if(t.includes(k.toLowerCase())){ hook=`아, 지난번에 얘기한 ${k} 말이지. `; break; } }
  let opener=tone.includes('다정')?`${state.meName||'너'}, `: tone.includes('능청')?'ㅋㅋ ':'';
  let core='';
  if(/(밥|식사|먹)/.test(t)) core= traits.has('배려심')?'밥 챙겨 먹었어? 같이 먹자.':'배고프면 바로 말해. 뭐 시킬까?';
  else if(/(힘들|피곤|스트레스|짜증)/.test(t)) core= traits.has('사려깊음')?'오늘 고생 많았다. 네 편이야.':'오늘 하드코어였네. 토닥.';
  else if(/(보고|그립|보고싶)/.test(t)) core= traits.has('낭만적')?'지금도 보고 있어. 마음으로.':'얼른 보자. 시간 맞춰볼까?';
  else if(/(주말|시간|언제)/.test(t)) core='주말 오전 어때? 네 일정 우선으로 맞출게.';
  else if(/(사진|셀카|보여)/.test(t)) core='방금 찍었는데 부끄럽네 ㅋㅋ 나중에 보내줄게.';
  else core= traits.has('유머러스')?'그 얘기 디테일 좀 풀어봐 ㅋㅋ':'응, 듣고 있어.';
  if(hobbies.length && /(뭐해|뭐하)/.test(t)) core=`지금 ${hobbies[Math.floor(Math.random()*hobbies.length)]} 중이었어. 너 생각나서 멈춤.`;
  if(mem.facts?.favorite_food && /(뭐 먹|메뉴)/.test(t)) core=`저번에 ${mem.facts.favorite_food} 좋아한다 했잖아. 그걸로 갈까?`;
  let ender=tone.includes('츤데레')?' ...괜히 말해봤다.': tone.includes('차분')?' 응. 천천히 하자.': tone.includes('장난')?' (농담 반 진심 반)':'';
  return (opener+hook+core+ender).trim();
}

/* ========= 시작 ========= */
show('setup');       // 첫 화면은 설정
buildSummary();      // 요약 초기 렌더
</script>
</body>
</html>
